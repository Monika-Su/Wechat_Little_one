<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
	<title>##title</title>
	<link rel="stylesheet" type="text/css" href="css/normalize.css">
	<link rel="stylesheet" type="text/css" href="css/retclub.css">
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.4.5.min.css">
	<link rel="stylesheet" type="text/css" href="css/thumbnail-gallery.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>\
	<![endif]-->
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top ">
	<div class="container">
		<span class="title">我的优惠券</span>
		</a>
	</div>
</nav>
<div class="page pageTop">
	<div id="knowledgeTop" style="padding-bottom: 8px; background: #fff;">
		<!-- NO background: url('images/banner.png') -->
		<a href="javascript:void(0)" onclick="javascript:void(0)"style="width:100%; position:relative ">
			<img src="images/header.jpg" alt="" width="100%" style="margin: auto;">
			<!-- No images/header.png in the folder-->
		</a>
	</div>
	<div id="coupon" hidden></div>
	<div id="##main_element">
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_1"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_2"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_3"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_4"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_5"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_6"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_7"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_8"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div id="##retClubRecommendName_9"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_10"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_11"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_12"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_13"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_14"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_15"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_16"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_17"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_18"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_19"></div>
		</div>
		<div class="col-lg-12 col-md-12 col-xs-12 thumb ##retClubRecommendName" >
			<div  id="##retClubRecommendName_20"></div>
		</div>
	</div>
</div>
<!-- /.container -->
<script src="js/jquery-1.11.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/i18next-1.7.4.min.js"></script>
<script type="text/javascript" src="js/i18nSetting.js"></script>
<script id="ret-js-template" type="text/javascript"></script>
<!-- <script type="text/javascript" src="//icemdev.retchat.com/RETchat.js?v=3"></script> -->
<script>
	var decodeUnicode = function( x ){
		var r = /\\u([\d\w]{4})/gi;
		x = x.replace(r, function (match, grp){
			return String.fromCharCode(parseInt(grp, 16));
		});
		return unescape(x);
	};
	var getCookie = function(name){
		var nameEQ = name + "=";
		var ca = document.cookie.split(';');
		for ( var i = 0, limit = ca.length; i < limit; i++) {
			var c = ca[i];
			c = c.trim();
			if (c.indexOf(nameEQ) == 0){
				return c.substring(nameEQ.length);
			}
		}
		return '';
	};
	var extractRootUrl = function (url) {
		var rootUrl
		var domain;
		var matches = url.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i);
		rootUrl = matches && matches[0];
		domain = matches && matches[1];
		return rootUrl;
	};
	function retchatCallBack() {
		//clear empty row
		$(".thumb").each(function() {
			if ($.trim($(this).html()) == '') $(this).remove();
		});
		$(".row").each(function() {
			if ($.trim($(this).html()) == '') $(this).remove();
		});
		$(".addCartBtn").show();
	}
	var retchatAccount = "##retchat_id";
	var elementId = "##main_element";
	var appid = "##appid";
	//	var loginUrl = "http://icemdev.retchat.com/agent/wechat/isMemberExisted?siteId=89&clubId=308&accountName=";
	var ua = navigator.userAgent.toLowerCase();
	var retUrlPrefix="##retUrlPrefix";
	var retCert = "##retCert";
	var retSiteId = "##siteId";
	var clubId = "##clubId";
	var shouldLoginRetclubFirst = "##enable_login";
	var retClubRecommendID = "##retClubRecommendID";
	var retClubRecommendName = "##retClubRecommendName";
	var host = "http://##retchat_server";
	var redirectUri = "http%3A%2F%2F##retchat_server%2Fretclub/##web_folder";
	var mid = getCookie(retchatAccount);
	var isLogin = getCookie( "isLogin" + retchatAccount );
	var urlMember = extractRootUrl( retUrlPrefix ) + "agent/wechat/getRetclubMemberInfo?siteId=" + retSiteId + "&accountName=";
	var orderList = getCookie('cart-' +retchatAccount);
	var getCouponList=null;
	var usedCoupon=[];
	(function() {
		var ret = document.createElement('script');
		ret.type = 'text/javascript';
		ret.async = true;
		ret.src = retUrlPrefix + 'ret.js?' + (new Date().getDate());
		var currentJs = document.getElementById('ret-js-template');
		currentJs.parentNode.insertBefore(ret, currentJs);
	})();
	if( typeof(mid) != "undefined" && mid.length > 0 ) {
		jQuery.ajax({
			url: urlMember + mid,
			success: function (resp) {
				userId = resp.data.memberId;
				var drawForWechat = function(ret){
					var itemList = $( "."+retClubRecommendName );
					var i=0;
					for( var itemId in ret ){
						if( itemList[i] != null){
							itemList[i].innerHTML = decodeUnicode( ret[ itemId ] );
							$(itemList[i]).attr('id', itemId);
							i++;
							isUsed(itemId);
						}
					}
					retchatCallBack();
					return retClubRecommendName;	// return for addRecClickMarkAtLink, sendItemImpression
				};
			},
			async: false
		});
	}
	var couponCountURL=extractRootUrl( retUrlPrefix )+"agent/wechatOrder/list/memberCoupons?siteId="+ retSiteId +"&memberId="+userId;
	jQuery.ajax({
		url: couponCountURL,
		success: function (resp) {
			getCouponList= resp.data;
		},
		async: false
	});
	function isUsed(id) {
		console.log(id);
		var idArry=[];
		idArry.push(id);
		if (getCouponList.length>0) {
			$.each(getCouponList, function (index, item) {
				var Isused = item.isUsed;
				var code = item.couponVO.code;
				for (var i = 0; i < idArry.length; i++) {
					if ((Isused == true) && (idArry[i]) == code) {
						$("#" + code).hide();
					}
				}
			})
		}
	}
	function addCart(itemCode){
		var couponURL = extractRootUrl(retUrlPrefix) + "agent/wechatOrder/receiveMemberCoupon?siteId=" + retSiteId + "&memberId=" + userId + "&couponCode=" + itemCode;
		var couponList=[];
		if (getCouponList.length>0) {
			$.each(getCouponList, function (index, item) {
				couponList.push(Number(item.couponVO.code));
				usedCoupon.push(item.isUsed);
			});
			if($.inArray(true,usedCoupon)!=-1){
				alert("已经使用此过优惠券");
			}
			else{
				if($.inArray(Number(itemCode),couponList)==-1){
					$.get(couponURL, function (resp) {
						if (resp.success == true) {
							alert("领取优惠券成功");
						}
					})
				}
				else{
					alert("已经领取，每人限领一次");
				}
			}
		}
		else {
			$.get(couponURL, function (resp) {
				if (resp.success == true) {
					alert("领取优惠券成功");
				}
			})
		}
		$('#' + itemCode + " " + ".collect").attr("disabled", "disabled");
		$('#' + itemCode + " " + ".collect").css({'border': '1px solid #ccc', 'color': '#ccc'});
		$('#' + itemCode + " " + ".collect").val("已领取");
	}
	function retchatCallBack() {
		$(".thumb").each(function () {
			if ($.trim($(this).html()) == '') $(this).remove();
		});
		$(".row").each(function () {
			if ($.trim($(this).html()) == '') $(this).remove();
		});
		$(".addCartBtn").show();
	}
	function getParameterByName(name) {
		name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"), results = regex.exec(location.search);
		return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
</script>
</body>
</html>

